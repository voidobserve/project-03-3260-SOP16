C51 COMPILER V9.60.7.0   RF_RECV                                                           07/10/2025 11:57:31 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE RF_RECV
OBJECT MODULE PLACED IN .\Release\Objects\rf_recv.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\rf_recv.c LARGE OPTIMIZE(9,SIZE) BROWSE INTVECTOR(0X000C) INC
                    -DIR(..\..\Libraries\Include;..\..\User;..\..\User\lib) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\rf_recv.l
                    -st) OBJECT(.\Release\Objects\rf_recv.obj)

line level    source

   1          // RF-315MHzºÍRF-433MHz½âÂëÔ´³ÌĞò
   2          /*
   3                  Ë¼Â·£ºÍ¨¹ıIOÖĞ¶Ï+¶¨Ê±Æ÷£¬µ±ÉÏÉıÑØÊ±¿ªÊ¼¼ÇÂ¼¸ßµçÆ½³ÖĞøÊ±¼ä£¬µ±ÏÂ½µÑØÊ±¿ªÊ¼¼ÇÂ¼µÍµçÆ½³ÖĞøÊ±¼ä
   4          
   5                  1. ÓĞ¸ßµçÆ½µ½À´Ê±£¬ËµÃ÷Ç°ÃæÒÑ¾­¼ÇÂ¼ÍêÒ»Î»ĞÅºÅ£¬»òÊÇµÚÒ»Î»ĞÅºÅµ½À´
   6                  2. ÅĞ¶Ï¸ßµçÆ½ºÍµÍµçÆ½³ÖĞøÊ±¼äÊ±£¬·¶Î§Òª¿íËÉĞ©£¬ÒÔÃâ³ö´í
   7                  3. Òª×¢ÒâÒ»Ö¡24Î»µÄÊı¾İµ½À´Ê±£¬Ç°ÃæÊÇÓĞ½Ï³¤µÄµÍµçÆ½ĞÅºÅ£¬ÄÄÅÂÊ±Á¬ĞøµÄĞÅºÅ£¬Ç°ÃæÒ²ÓĞ10msÒÔÉÏµÄµÍµçÆ½ĞÅºÅ¡£
   8                  ¸ù¾İÕâÒ»µã¿ÉÒÔÇø·Ö²»Í¬µÄÖ¡£¬ÒÔÃâÊı¾İ´íÎ»
   9          
  10          */
  11          #include "rf_recv.h"
  12          #include "my_gpio.h"
  13          #include "send_key.h"
  14          #include "flash.h" // µ¥Æ¬»úÉÏµÄflashÏà¹Ø²Ù×÷
  15          
  16          #include <stdlib.h> // NULLµÄ¶¨Òå
  17          
  18          // ¶¨Ê±Æ÷TMR0µÄ¼ÆÊ±ÖÜÆÚ£¬Ò²ÊÇÖĞ¶Ï´¥·¢ÖÜÆÚ£¨Ã¿¸ô¶à¾Ã´¥·¢Ò»´ÎÖĞ¶Ï£©
  19          // ¼ÆÊ±ÖÜÆÚ²»ÄÜ´óÓÚ65535£¬ÒòÎªTMR0´æ·Å¼ÆÊ±ÖÜÆÚµÄ¼Ä´æÆ÷Ö»ÓĞ16Î»
  20          // ÏÖÔÚÈÃ¶¨Ê±Æ÷TMR0Ã¿100us´¥·¢Ò»´ÎÖĞ¶Ï£¨Êµ¼ÊÉÏÓĞÊ±ºòÊÇ120us£¬ÓĞÊ±ºòÊÇ80us£¬ºÃÏñÊÇÂÖÁ÷À´µÄ£©
  21          #define TMR0_CNT_TIME ((152)) // 152 * 0.65625us == 99.75us£¬Ô¼µÈÓÚ100us £¨ÕâÊÇ¼ÆËãµÃ³öµÄ£¬Êµ¼ÊÉÏ»áÓĞÎó²î£
             -¬¿ÉÄÜĞèÒª¸ù¾İÊµÇé¿öÀ´µ÷ÊÔ¡¢ĞŞ¸Ä£©
  22          
  23          static volatile int recv_bit_flag = 0; // ÊÇ·ñ½ÓÊÕµ½ÍêÕûµÄÒ»Î»ĞÅºÅµÄ±êÖ¾Î»
  24          static volatile u32 tmr0_cnt = 0;          // ¶¨Ê±Æ÷ÖĞ¶Ï·şÎñº¯ÊıÖĞ£¬Ê¹ÓÃµ½µÄ¼ÆÊıÖµ
  25          
  26          static volatile u32 high_level_time = 0; // ÓÃÀ´µ¥¶À±£´æ¶¨Ê±Æ÷µÄ¼ÆÊıÖµ£¨¶¨Ê±Ê±¼ä£©£¬·ÀÖ¹¶¨Ê±Æ÷ÖØ¸´¶¨Ê±£¬Ôì
             -³Étmr0_cntµÄÊı¾İ¸²¸Ç
  27          static volatile u32 low_level_time = 0;  // ´æ·ÅµÍµçÆ½³ÖĞøµÄÊ±¼ä
  28          
  29          volatile u32 rf_data = 0; // ÓÃÓÚ´æ·Å½ÓÊÕµ½µÄ24Î»Êı¾İ
  30          
  31          volatile int recv_rf_flag = 0; // ÊÇ·ñ½ÓÊÕµ½ÍêÕûµÄrfĞÅºÅµÄ±êÖ¾Î»
  32          
  33          // ÓÃÓÚ´æ·Å½ÓÊÕµ½µÄ24Î»Êı¾İ£¬½ÓÊÕn´Î£¬ÔÙÅĞ¶ÏÕâÀïÃæÓĞÃ»ÓĞÆ÷¼şµØÖ·ÖØ¸´µØ¡¢²¢ÇÒÊÇ³öÏÖ´ÎÊı×î¶àµÄ
  34          // Èç¹ûÓĞ£¬Ôò±£´æÏÂËüµÄÆ÷¼şµØÖ·
  35          // Èç¹ûÃ»ÓĞ£¬ÔòºöÂÔ
  36          // ½ÓÊÕÍêÕûµÄÒ»´ÎĞÅºÅËÄÉáÎåÈëºóÔ¼Îª50ms£¬ÕâÀï½ÓÊÕ20´Î£¬Ò»¹²1000ms£¬Ò²¾ÍÊÇ³¤°´1s×óÓÒ¾Í¿ÉÒÔÑ§Ï°¡¢±£´æ¶ÔÓ¦µÄµ
             -ØÖ·
  37          volatile u32 rf_data_buf[20] = {0};
  38          static volatile unsigned char rf_data_buf_index = 0; // ½ÓÊÕÊı¾İ»º³åÇøµÄË÷Òı
  39          unsigned char rf_data_buf_overflow = 0;                          // ½ÓÊÕ»º³åÇøÒç³öµÄ±êÖ¾Î»
  40          
  41          // RFINÒı½Å³õÊ¼»¯£¨RF½ÓÊÕÒı½Å³õÊ¼»¯£©
  42          // ÕâÀïÒ²Ê¹ÓÃµ½ÁË¶¨Ê±Æ÷TMR0£¬ÅäÖÃ³ÉÃ¿100us×óÓÒ²úÉúÒ»´ÎÖĞ¶Ï£¨Îó²î20us£©£¬²»¹ı¸Ãº¯Êıµ÷ÓÃÍêºó£¬¶¨Ê±Æ÷TMR0ÊÇ¹Ø
             -±ÕµÄ(×îĞÂ°æÊÇÒ»Ö±´ò¿ª100usµÄÖĞ¶Ï)
  43          void rfin_init(void)
  44          {
  45   1      
  46   1      #ifdef DEVELOPMENT_BOARD
              
                      // ÅäÖÃP0_2ÎªÊäÈëÄ£Ê½
                      P0_MD0 &= ~GPIO_P02_MODE_SEL(0x01);
C51 COMPILER V9.60.7.0   RF_RECV                                                           07/10/2025 11:57:31 PAGE 2   

                      // ÅäÖÃP0_2ÎªÏÂÀ­£¬ÒòÎªRF½ÓÊÕÄ£¿éµÄÊä³öÔÚ¿ÕÏĞÊ±Ä¬ÈÏÎªµÍµçÆ½
                      P0_PD |= GPIO_P02_PULL_PD(0x01);
              
                      __SetIRQnIP(P0_IRQn, P0_IQn_CFG);       // ÉèÖÃÖĞ¶ÏÓÅÏÈ¼¶
                      __EnableIRQ(P0_IRQn);                           // Ê¹ÄÜÖĞ¶Ï
                      IE_EA = 1;                                                      // Ê¹ÄÜ×Ü¿ª¹Ø
                      P0_IMK |= GPIO_P02_IRQ_MASK(0x01);      // ´ò¿ªP02µÄÖĞ¶Ï
                      P0_TRG0 &= ~GPIO_P02_TRG_SEL(0x03); // ÅäÖÃP02ÎªË«±ßÑØ´¥·¢
              
              #endif // end ifdef DEVELOPMENT_BOARD
  60   1      
  61   1      #ifdef CIRCUIT_BOARD
  62   1      
  63   1              P1_PU |= GPIO_P13_PULL_UP(0x01); // ÉÏÀ­
  64   1              // ÅäÖÃP1_3ÎªÊäÈëÄ£Ê½
  65   1              P1_MD0 &= ~GPIO_P13_MODE_SEL(0x03);
  66   1      
  67   1              // ÅäÖÃP1_3ÎªÏÂÀ­£¬ÒòÎªRF½ÓÊÕÄ£¿éµÄÊä³öÔÚ¿ÕÏĞÊ±Ä¬ÈÏÎªµÍµçÆ½
  68   1              // P1_PD |= GPIO_P13_PULL_PD(0x01);
  69   1      
  70   1              // __SetIRQnIP(P1_IRQn, P1_IQn_CFG);    // ÉèÖÃÖĞ¶ÏÓÅÏÈ¼¶
  71   1              // __EnableIRQ(P1_IRQn);                                // Ê¹ÄÜÖĞ¶Ï
  72   1              // IE_EA = 1;                                                   // Ê¹ÄÜ×Ü¿ª¹Ø
  73   1              // P1_IMK |= GPIO_P13_IRQ_MASK(0x01);   // ´ò¿ªP13µÄÖĞ¶Ï
  74   1              // P1_TRG0 &= ~GPIO_P13_TRG_SEL(0x03); // ÅäÖÃP13ÎªË«±ßÑØ´¥·¢
  75   1      
  76   1      #endif // end ifdef CIRCUIT_BOARD
  77   1      
  78   1      // ============================================================ //
  79   1      #if 0
                      // ÅäÖÃ¶¨Ê±Æ÷£¬ÓÃÀ´¼ÇÂ¼RF½ÓÊÕµ½µÄ¸ßµçÆ½³ÖĞøÊ±¼ä
                      __SetIRQnIP(TMR0_IRQn, TMR0_IQn_CFG); // ÉèÖÃÖĞ¶ÏÓÅÏÈ¼¶£¨TMR0£©
              
                      TMR0_CONL &= ~TMR_PRESCALE_SEL(0x03); // Çå³ıTMR0µÄÔ¤·ÖÆµÅäÖÃ¼Ä´æÆ÷
              
                      // ÅäÖÃTMR0µÄÔ¤·ÖÆµ£¬Îª32·ÖÆµ£¬¼´21MHz / 32 = 0.67MHz£¬Ô¼0.67us¼ÆÊıÒ»´Î£¬
                      // £¨Êµ¼Ê²âÊÔºÍ¼ÆËãµÃ³öÕâ¸öÏµÍ³Ê±ÖÓÊÇ21MHzµÄ£¬µ«ÊÇ»¹ÊÇÓĞĞ©Îó²î£©
                      TMR0_CONL |= TMR_PRESCALE_SEL(0x05);
                      TMR0_CONL &= ~TMR_MODE_SEL(0x03); // Çå³ıTMR0µÄÄ£Ê½ÅäÖÃ¼Ä´æÆ÷
                      TMR0_CONL |= TMR_MODE_SEL(0x01);  // ÅäÖÃTMR0µÄÄ£Ê½Îª¼ÆÊıÆ÷Ä£Ê½£¬×îºó¶ÔÏµÍ³Ê±ÖÓµÄÂö³å½øĞĞ¼ÆÊı
              
                      TMR0_CONH &= ~TMR_PRD_PND(0x01); // Çå³ıTMR0µÄ¼ÆÊı±êÖ¾Î»£¬±íÊ¾Î´Íê³É¼ÆÊı
                      TMR0_CONH |= TMR_PRD_IRQ_EN(1);  // Ê¹ÄÜTMR0µÄ¼ÆÊıÖĞ¶Ï
              
                      // ÅäÖÃTMR0µÄ¼ÆÊıÖÜÆÚ
                      TMR0_PRL = (unsigned char)(TMR0_CNT_TIME % 255);
                      TMR0_PRH = (unsigned char)(TMR0_CNT_TIME / 255);
              
                      // Çå³ıTMR0µÄ¼ÆÊıÖµ
                      TMR0_CNTL = 0;
                      TMR0_CNTH = 0;
              
                      TMR0_CONL &= ~(TMR_SOURCE_SEL(0x07)); // Çå³ıTMR0µÄÊ±ÖÓÔ´ÅäÖÃ¼Ä´æÆ÷
                      TMR0_CONL |= TMR_SOURCE_SEL(0x05);        // ÅäÖÃTMR0µÄÊ±ÖÓÔ´£¬²»ÓÃÈÎºÎÊ±ÖÓ
                                                                                                // __EnableIRQ(TMR0_IRQn);                       // Ê¹ÄÜÖĞ¶Ï
              
                      __DisableIRQ(TMR0_IRQn); // ½ûÓÃÖĞ¶Ï
              #endif
 108   1      }
 109          
 110          // // TMR0ÖĞ¶Ï·şÎñº¯Êı
 111          // void TIMR0_IRQHandler(void) interrupt TMR0_IRQn
C51 COMPILER V9.60.7.0   RF_RECV                                                           07/10/2025 11:57:31 PAGE 3   

 112          // {
 113          //      // ½øÈëÖĞ¶ÏÉèÖÃIP£¬²»¿ÉÉ¾³ı
 114          //      __IRQnIPnPush(TMR0_IRQn);
 115          
 116          //      // ---------------- ÓÃ»§º¯Êı´¦Àí -------------------
 117          
 118          //      // ÖÜÆÚÖĞ¶Ï
 119          //      if (TMR0_CONH & TMR_PRD_PND(0x1))
 120          //      {
 121          //              TMR0_CONH |= TMR_PRD_PND(0x1); // Çå³ıpending
 122          
 123          //              tmr0_cnt++; // Ã¿80us»ò120us»á¼ÓÒ»´Î
 124          
 125          //              // P12 = ~P12;
 126          //      }
 127          
 128          //      // ÍË³öÖĞ¶ÏÉèÖÃIP£¬²»¿ÉÉ¾³ı
 129          //      __IRQnIPnPop(TMR0_IRQn);
 130          // }
 131          
 132          // ¿ªÆô¶¨Ê±Æ÷TMR0£¬¿ªÊ¼¼ÆÊ±
 133          // void tmr0_enable(void)
 134          // {
 135          //      // ÖØĞÂ¸øTMR0ÅäÖÃÊ±ÖÓ
 136          //      TMR0_CONL &= ~(TMR_SOURCE_SEL(0x07)); // Çå³ı¶¨Ê±Æ÷µÄÊ±ÖÓÔ´ÅäÖÃ¼Ä´æÆ÷
 137          //      TMR0_CONL |= TMR_SOURCE_SEL(0x06);        // ÅäÖÃ¶¨Ê±Æ÷µÄÊ±ÖÓÔ´£¬Ê¹ÓÃÏµÍ³Ê±ÖÓ£¨Ô¼21MHz£©
 138          
 139          //      __EnableIRQ(TMR0_IRQn); // Ê¹ÄÜÖĞ¶Ï
 140          // }
 141          
 142          // ¹Ø±Õ¶¨Ê±Æ÷0£¬Çå¿Õ¼ÆÊıÖµ
 143          // void tmr0_disable(void)
 144          // {
 145          //      // ²»¸ø¶¨Ê±Æ÷Ìá¹©Ê±ÖÓ£¬ÈÃËüÍ£Ö¹¼ÆÊı
 146          //      TMR0_CONL &= ~(TMR_SOURCE_SEL(0x07)); // Çå³ı¶¨Ê±Æ÷µÄÊ±ÖÓÔ´ÅäÖÃ¼Ä´æÆ÷
 147          //      TMR0_CONL |= TMR_SOURCE_SEL(0x05);        // ÅäÖÃ¶¨Ê±Æ÷µÄÊ±ÖÓÔ´£¬²»ÓÃÈÎºÎÊ±ÖÓ
 148          
 149          //      // Çå³ı¶¨Ê±Æ÷µÄ¼ÆÊıÖµ
 150          //      TMR0_CNTL = 0;
 151          //      TMR0_CNTH = 0;
 152          
 153          //      __DisableIRQ(TMR0_IRQn); // ¹Ø±ÕÖĞ¶Ï£¨²»Ê¹ÄÜÖĞ¶Ï£©
 154          // }
 155          
 156          #ifdef DEVELOPMENT_BOARD
              // P0ÖĞ¶Ï·şÎñº¯Êı
              void P0_IRQHandler(void) interrupt P0_IRQn
              {
                      // Px_PND¼Ä´æÆ÷Ğ´ÈÎºÎÖµ¶¼»áÇå±êÖ¾Î»
                      u8 p0_pnd = P0_PND;
              
                      static volatile int i = 0; // ¼ÆÊıÖµ£¬¼ÇÂ¼µ±Ç°½ÓÊÕµÄÊı¾İÎ»Êı
              
                      // ½øÈëÖĞ¶ÏÉèÖÃIP£¬²»¿ÉÉ¾³ı
                      __IRQnIPnPush(P0_IRQn);
                      __DisableIRQ(P0_IRQn); // ½ûÓÃIO¿ÚÖĞ¶Ï
              
                      // ---------------- ÓÃ»§º¯Êı´¦Àí -------------------
              
                      if (p0_pnd & GPIO_P02_IRQ_PNG(0x1)) // Çå³ı±êÖ¾Î»
                      {
                              // ÔÚÕâÀï±àĞ´ÖĞ¶Ï·şÎñº¯ÊıµÄ´úÂë
C51 COMPILER V9.60.7.0   RF_RECV                                                           07/10/2025 11:57:31 PAGE 4   

              
                              // ¸ù¾İÒı½Åµ±Ç°µÄµçÆ½À´´ò¿ª/¹Ø±Õ¶¨Ê±Æ÷TMR0£¬×îºó¼ÇÂ¼Ò»¸ö¸ßµçÆ½ĞÅºÅµÄ³ÖĞøÊ±¼ä
                              if (RFIN == 1)
                              {
                                      // Èç¹û´ËÊ±Òı½ÅÊÇ¸ßµçÆ½£¬¶ÁÈ¡¼ÇÂ¼µÄµÍµçÆ½µÄÊ±¼ä
                                      low_level_time = tmr0_cnt;
                                      tmr0_cnt = 0; // Çå³ıµçÆ½Ê±¼ä¼ÆÊıÖµ
              
                                      // Èç¹ûÏÖÔÚÊÇ¸ßµçÆ½£¬Ö®Ç°¿ÉÄÜ½ÓÊÕÁËÒ»Î»µÄĞÅºÅ£¨¸ßµçÆ½+µÍµçÆ½£©
                                      // Ò»Î»ÍêÕûµÄĞÅºÅ¼ÇÂ¼Íê³É£¬¸ø¶ÔÓ¦µÄ±êÖ¾Î»ÖÃÒ»
                                      recv_bit_flag = 1;
                              }
                              else
                              {
                                      // Èç¹û´ËÊ±Òı½ÅÊÇµÍµçÆ½£¬¶ÁÈ¡¼ÇÂ¼µÄµçÆ½³ÖĞøÊ±¼ä
              
                                      high_level_time = tmr0_cnt; // ¶Á³öÒ»´Î¸ßµçÆ½³ÖĞøÊ±¼ä
                                      tmr0_cnt = 0;                           // Çå³ıµçÆ½Ê±¼ä¼ÆÊıÖµ
                              }
              
                              // ÔÚÖĞ¶Ï·şÎñº¯ÊıÖĞ½øĞĞ½âÂë
                              if (recv_bit_flag)
                              {
                                      // Èç¹ûÊÕµ½ÁËÒ»´ÎÍêÕûµÄ¸ßµçÆ½£¨960usµÄ"1"»ò320usµÄ"0"£©
                                      recv_bit_flag = 0; // Çå³ı±êÖ¾Î»
              
                                      if (low_level_time > 50)
                                      {
                                              // Èç¹ûµÍµçÆ½³ÖĞøÊ±¼ä´óÓÚ50 * 100us£¨5ms£©£¬×¼±¸ÏÂÒ»´ÎÔÙ¶ÁÈ¡ÓĞĞ§ĞÅºÅ
                                              rf_data = 0; // Çå³ı½ÓÊÕµÄÊı¾İÖ¡
                                              i = 0;           // Çå³ıÓÃÀ´¼ÇÂ¼½ÓÊÕµÄÊı¾İÎ»Êı
                                      }
              
                                      // ÅĞ¶Ï¸ßµçÆ½³ÖĞøÊ±¼äºÍµÍµçÆ½³ÖĞøÊ±¼ä£¬ÊÇ·ñ·ûºÏ·¶Î§
                                      else if (high_level_time > 1 && high_level_time <= 6 && low_level_time >= 5 && low_level_time <= 20)
                                      {
                                              // Èç¹ûÊÇ360us×óÓÒµÄ¸ßµçÆ½ºÍ880us×óÓÒµÄµÍµçÆ½£¬ËµÃ÷ÊÇ"0"
                                              rf_data &= ~1;
                                              i++;
                                              if (i != 24)
                                              {
                                                      rf_data <<= 1; // ÓÃÓÚ´æ·Å½ÓÊÕ24Î»Êı¾İµÄ±äÁ¿×óÒÆÒ»Î»
                                              }
                                      }
                                      else if (high_level_time >= 5 && high_level_time <= 20 && low_level_time >= 1 && low_level_time < 10)
                                      {
                                              // Èç¹ûÊÇ960us×óÓÒµÄ¸ßµçÆ½ºÍ280us×óÓÒµÄµÍµçÆ½£¬ËµÃ÷ÊÇ"1"
                                              rf_data |= 1;
                                              i++;
                                              if (i != 24)
                                              {
                                                      rf_data <<= 1; // ÓÃÓÚ´æ·Å½ÓÊÕ24Î»Êı¾İµÄ±äÁ¿×óÒÆÒ»Î»
                                              }
                                      }
                                      else
                                      {
                                              // ¼È²»ÊÇ"0"Ò²²»ÊÇ"1"£¬ËµÃ÷±¾´ÎµÄ½ÓÊÕÎŞĞ§
                                              rf_data = 0;
                                              i = 0;
              
                                              // P12 = ~P12;
                                      }
C51 COMPILER V9.60.7.0   RF_RECV                                                           07/10/2025 11:57:31 PAGE 5   

              
                                      if (i >= 24)
                                      {
                                              // Èç¹û½ÓÊÕÁË24Î»Êı¾İ£¨0~23£¬×îºóÒ»´Îi++Ö±½Ó±ä³É24£©£¬ËµÃ÷Ò»´Î½ÓÊÕÍê³É
                                              recv_rf_flag = 1;
                                              i = 0;
                                      }
                              }
                      }
              
                      P0_PND = p0_pnd; // ÇåP2ÖĞ¶Ï±êÖ¾Î»£¬Ğ´ÈÎºÎÖµ¶¼»áÇå±êÖ¾Î»
              
                      // -------------------------------------------------
                      __EnableIRQ(P0_IRQn); // Ê¹ÄÜIO¿ÚÖĞ¶Ï
                      // ÍË³öÖĞ¶ÏÉèÖÃIP£¬²»¿ÉÉ¾³ı
                      __IRQnIPnPop(P0_IRQn);
              }
              #endif // end ifdef DEVELOPMENT_BOARD
 254          
 255          #ifdef CIRCUIT_BOARD
 256          
 257          #if 0
              // P1ÖĞ¶Ï·şÎñº¯Êı
              void P1_IRQHandler(void) interrupt P1_IRQn
              {
                      // Px_PND¼Ä´æÆ÷Ğ´ÈÎºÎÖµ¶¼»áÇå±êÖ¾Î»
                      u8 p1_pnd = P1_PND;
              
                      static volatile int i = 0; // ¼ÆÊıÖµ£¬¼ÇÂ¼µ±Ç°½ÓÊÕµÄÊı¾İÎ»Êı
              
                      // ½øÈëÖĞ¶ÏÉèÖÃIP£¬²»¿ÉÉ¾³ı
                      __IRQnIPnPush(P1_IRQn);
                      __DisableIRQ(P1_IRQn); // ½ûÓÃIO¿ÚÖĞ¶Ï
              
                      // ---------------- ÓÃ»§º¯Êı´¦Àí -------------------
              
                      if (p1_pnd & GPIO_P13_IRQ_PNG(0x1)) // Çå³ı±êÖ¾Î»
                      {
                              // ÔÚÕâÀï±àĞ´ÖĞ¶Ï·şÎñº¯ÊıµÄ´úÂë
              
                              // ¸ù¾İÒı½Åµ±Ç°µÄµçÆ½À´´ò¿ª/¹Ø±Õ¶¨Ê±Æ÷TMR0£¬×îºó¼ÇÂ¼Ò»¸ö¸ßµçÆ½ĞÅºÅµÄ³ÖĞøÊ±¼ä
                              if (RFIN == 1)
                              {
                                      // Èç¹û´ËÊ±Òı½ÅÊÇ¸ßµçÆ½£¬¶ÁÈ¡¼ÇÂ¼µÄµÍµçÆ½µÄÊ±¼ä
                                      low_level_time = tmr0_cnt;
                                      tmr0_cnt = 0; // Çå³ıµçÆ½Ê±¼ä¼ÆÊıÖµ
              
                                      // Èç¹ûÏÖÔÚÊÇ¸ßµçÆ½£¬Ö®Ç°¿ÉÄÜ½ÓÊÕÁËÒ»Î»µÄĞÅºÅ£¨¸ßµçÆ½+µÍµçÆ½£©
                                      // Ò»Î»ÍêÕûµÄĞÅºÅ¼ÇÂ¼Íê³É£¬¸ø¶ÔÓ¦µÄ±êÖ¾Î»ÖÃÒ»
                                      recv_bit_flag = 1;
                              }
                              else
                              {
                                      // Èç¹û´ËÊ±Òı½ÅÊÇµÍµçÆ½£¬¶ÁÈ¡¼ÇÂ¼µÄµçÆ½³ÖĞøÊ±¼ä
              
                                      high_level_time = tmr0_cnt; // ¶Á³öÒ»´Î¸ßµçÆ½³ÖĞøÊ±¼ä
                                      tmr0_cnt = 0;                           // Çå³ıµçÆ½Ê±¼ä¼ÆÊıÖµ
                              }
              
                              // ÔÚÖĞ¶Ï·şÎñº¯ÊıÖĞ½øĞĞ½âÂë
                              if (recv_bit_flag)
                              {
C51 COMPILER V9.60.7.0   RF_RECV                                                           07/10/2025 11:57:31 PAGE 6   

                                      // Èç¹ûÊÕµ½ÁËÒ»´ÎÍêÕûµÄ¸ßµçÆ½£¨960usµÄ"1"»ò320usµÄ"0"£©
                                      recv_bit_flag = 0; // Çå³ı±êÖ¾Î»
              
                                      if (low_level_time > 50)
                                      {
                                              // Èç¹ûµÍµçÆ½³ÖĞøÊ±¼ä´óÓÚ50 * 100us£¨5ms£©£¬×¼±¸ÏÂÒ»´ÎÔÙ¶ÁÈ¡ÓĞĞ§ĞÅºÅ
                                              rf_data = 0; // Çå³ı½ÓÊÕµÄÊı¾İÖ¡
                                              i = 0;           // Çå³ıÓÃÀ´¼ÇÂ¼½ÓÊÕµÄÊı¾İÎ»Êı
                                      }
              
                                      // ÅĞ¶Ï¸ßµçÆ½³ÖĞøÊ±¼äºÍµÍµçÆ½³ÖĞøÊ±¼ä£¬ÊÇ·ñ·ûºÏ·¶Î§
                                      else if (high_level_time > 1 && high_level_time <= 6 && low_level_time >= 5 && low_level_time <= 20)
                                      {
                                              // Èç¹ûÊÇ360us×óÓÒµÄ¸ßµçÆ½ºÍ880us×óÓÒµÄµÍµçÆ½£¬ËµÃ÷ÊÇ"0"
                                              rf_data &= ~1;
                                              i++;
                                              if (i != 24)
                                              {
                                                      rf_data <<= 1; // ÓÃÓÚ´æ·Å½ÓÊÕ24Î»Êı¾İµÄ±äÁ¿×óÒÆÒ»Î»
                                              }
                                      }
                                      else if (high_level_time >= 5 && high_level_time <= 20 && low_level_time >= 1 && low_level_time < 10)
                                      {
                                              // Èç¹ûÊÇ960us×óÓÒµÄ¸ßµçÆ½ºÍ280us×óÓÒµÄµÍµçÆ½£¬ËµÃ÷ÊÇ"1"
                                              rf_data |= 1;
                                              i++;
                                              if (i != 24)
                                              {
                                                      rf_data <<= 1; // ÓÃÓÚ´æ·Å½ÓÊÕ24Î»Êı¾İµÄ±äÁ¿×óÒÆÒ»Î»
                                              }
                                      }
                                      else
                                      {
                                              // ¼È²»ÊÇ"0"Ò²²»ÊÇ"1"£¬ËµÃ÷±¾´ÎµÄ½ÓÊÕÎŞĞ§
                                              rf_data = 0;
                                              i = 0;
              
                                              // P12 = ~P12;
                                      }
              
                                      if (i >= 24)
                                      {
                                              // Èç¹û½ÓÊÕÁË24Î»Êı¾İ£¨0~23£¬×îºóÒ»´Îi++Ö±½Ó±ä³É24£©£¬ËµÃ÷Ò»´Î½ÓÊÕÍê³É
                                              recv_rf_flag = 1;
                                              i = 0;
                                      }
                              }
                      }
              
                      P1_PND = p1_pnd; // ÇåP2ÖĞ¶Ï±êÖ¾Î»£¬Ğ´ÈÎºÎÖµ¶¼»áÇå±êÖ¾Î»
              
                      // -------------------------------------------------
                      __EnableIRQ(P1_IRQn); // Ê¹ÄÜIO¿ÚÖĞ¶Ï
                      // ÍË³öÖĞ¶ÏÉèÖÃIP£¬²»¿ÉÉ¾³ı
                      __IRQnIPnPop(P1_IRQn);
              }
              #endif
 355          
 356          #endif // end of #ifdef CIRCUIT_BOARD
 357          
 358          // ÅĞ¶ÏÊı×éÖĞ³öÏÖ´ÎÊı×î¶àµÄÔªËØ
 359          // Èç¹û³öÏÖ´ÎÊıÒ»Ñù¶à£¬Ö»»á·µ»Ø´ÎÊıÒ»ÑùµÄµÚÒ»¸öÔªËØ
C51 COMPILER V9.60.7.0   RF_RECV                                                           07/10/2025 11:57:31 PAGE 7   

 360          // Èç¹û ²ÎÊı element ÎªNULL£¬Ôò²»»á¸ø²ÎÊıelement¶ÔÓ¦µÄ¿Õ¼ä¸³Öµ
 361          // Èç¹û ²ÎÊı index ÎªNULL£¬Ôò²»»á¸ø²ÎÊıindex¶ÔÓ¦µÄ¿Õ¼ä¸³Öµ
 362          void appear_themost(u32 *arr, u32 arr_len, u32 *element, u32 *index)
 363          {
 364   1              u32 themost = 0;                // ³öÏÖ´ÎÊı×î¶àµÄÔªËØµÄÖµ
 365   1              u16 themost_index = -1; // ³öÏÖ´ÎÊı×î¶àµÄÔªËØËùÔÚÊı×éÖĞµÄÏÂ±ê
 366   1              u32 themost_cnt = 0;    // ³öÏÖ´ÎÊı×î¶àµÄÔªËØ¶ÔÓ¦µÄ¸öÊı
 367   1      
 368   1              u32 cur_element = 0;     // ¼ÇÂ¼ÏÂµ±Ç°µÄÔªËØµÄÖµ
 369   1              u32 cur_element_cnt = 0; // ¼ÇÂ¼µ±Ç°ÔªËØµÄ³öÏÖ´ÎÊı
 370   1      
 371   1              int i = 0;
 372   1              int j = 0;
 373   1      
 374   1              // ´íÎó´¦Àí
 375   1              if (arr == NULL)
 376   1              {
 377   2                      return;
 378   2              }
 379   1      
 380   1              for (i = 0; i < arr_len; i++)
 381   1              {
 382   2                      cur_element = arr[i]; // ¼ÇÂ¼ÏÂµ±Ç°µÄÔªËØµÄÖµ£¬½ÓÏÂÀ´µÄÑ­»·ÖĞ¼ÇÂ¼µ±Ç°ÔªËØ³öÏÖµÄ¸öÊı
 383   2                      cur_element_cnt = 0;
 384   2                      for (j = 0; j < arr_len; j++)
 385   2                      {
 386   3                              if (cur_element == arr[j])
 387   3                              {
 388   4                                      // Èç¹ûÊı×éÖĞ³öÏÖ¹ıÒ»´Î¸ÃÔªËØ£¬ÔòÈÃ¼ÆÊıÖµ¼ÓÒ»
 389   4                                      cur_element_cnt++;
 390   4                              }
 391   3                      }
 392   2      
 393   2                      // µ½ÁËÕâÀï£¬±ãµÃµ½ÁËÒ»¸öÔªËØÔÚÕâ¸öÊı×éÖĞ³öÏÖµÄ´ÎÊı
 394   2                      // ¸úÒÑÖª³öÏÖ´ÎÊı×î¶àµÄÔªËØÏà±È½Ï£¬Èç¹ûÔªËØµÄÊıÖµ²»Ò»ÑùÇÒµ±Ç°ÔªËØµÄ³öÏÖ´ÎÊı¸ü¶à£¬
 395   2                      // ÔòÈÃµ±Ç°ÔªËØ×÷ÎªÒÑÖªµÄ³öÏÖ´ÎÊı×î¶àµÄÔªËØ
 396   2                      if (cur_element != themost && cur_element_cnt > themost_cnt)
 397   2                      {
 398   3                              themost = cur_element;
 399   3                              themost_cnt = cur_element_cnt;
 400   3                              themost_index = j - 1; // ÁÙÊ±¼ÇÂ¼Ëü¶ÔÓ¦µÄÊı×éÏÂ±ê
 401   3                      }
 402   2              }
 403   1      
 404   1              // ×îºó£¬Í¨¹ıĞÎ²Î·µ»Ø³öÏÖ´ÎÊı×î¶àµÄÔªËØµÄÖµºÍËüËù¶ÔÓ¦µÄÊı×éÏÂ±ê
 405   1              if (NULL != element)
 406   1              {
 407   2                      *element = themost;
 408   2              }
 409   1      
 410   1              if (index != NULL)
 411   1              {
 412   2                      *index = themost_index;
 413   2              }
 414   1      
 415   1              // send_keyval(themost >> 16); // ²âÊÔÓÃ£¨²âÊÔÍ¨¹ı£©
 416   1              // send_keyval(themost & 0xFFFF);
 417   1      }
 418          
 419          // ½ÓÊÕRFĞÅºÅµ½»º³åÇøÖĞ£¬½ÓÊÕn´ÎĞÅºÅ£¨nÊÇÊı×éÖ§³ÖµÄÔªËØ¸öÊı£¬¿ÉÒÔ¸ù¾İĞèÒªĞŞ¸Ä£©
 420          void rf_recv_databuf(void)
 421          {
C51 COMPILER V9.60.7.0   RF_RECV                                                           07/10/2025 11:57:31 PAGE 8   

 422   1              // u32 appear_themost = 0; // ²âÊÔÓÃµÄ±äÁ¿
 423   1              u32 index = 0;
 424   1              // int i = 0; // Ñ­»·¼ÆÊıÖµ £¨²âÊÔÓÃ£©
 425   1      
 426   1              if (recv_rf_flag)
 427   1              {
 428   2                      // Èç¹û³É¹¦½ÓÊÕÁË24Î»µÄÊı¾İ£¬½«Æä±£´æµ½»º³åÇøÖĞ
 429   2                      recv_rf_flag = 0;
 430   2      // #ifdef DEVELOPMENT_BOARD
 431   2      //              __DisableIRQ(P0_IRQn); // ½ûÓÃIO¿ÚÖĞ¶Ï£¬ÕâÊ±²»ÄÜÔÙ´ÓRF½ÓÊÕÒı½Å½ÓÊÕĞÂµÄÊı¾İ
 432   2      // #endif                                                  // end ifdef DEVELOPMENT_BOARD
 433   2      // #ifdef CIRCUIT_BOARD
 434   2      //              __DisableIRQ(P1_IRQn);                                          // ½ûÓÃIO¿ÚÖĞ¶Ï£¬ÕâÊ±²»ÄÜÔÙ´ÓRF½ÓÊÕÒı½Å½ÓÊÕĞÂµÄÊı¾İ
 435   2      // #endif                                                                                               // end ifdef CIRCUIT_BOARD
 436   2                      rf_data_buf[rf_data_buf_index++] = rf_data; // ´æ·ÅÒ»´ÎÊı¾İ
 437   2      
 438   2      // send_keyval(rf_data & 0xFF);
 439   2      // #ifdef DEVELOPMENT_BOARD
 440   2      //              __EnableIRQ(P0_IRQn); // Ê¹ÄÜIO¿ÚÖĞ¶Ï
 441   2      // #endif                                                 // end ifdef DEVELOPMENT_BOARD
 442   2      // #ifdef CIRCUIT_BOARD
 443   2      //              __EnableIRQ(P1_IRQn); // Ê¹ÄÜIO¿ÚÖĞ¶Ï
 444   2      // #endif                                                 // end ifdef CIRCUIT_BOARD
 445   2              }
 446   1      
 447   1              if (rf_data_buf_index == sizeof(rf_data_buf) / sizeof(rf_data_buf[0]))
 448   1              {
 449   2                      // Èç¹û½ÓÊÕÁËn´ÎÊı¾İ
 450   2                      rf_data_buf_index = 0;    // Êı×é£¨»º³åÇø£©ÏÂ±êÇåÁã
 451   2                      rf_data_buf_overflow = 1; // Êı×é£¨»º³åÇø£©Òç³ö±êÖ¾ÖÃÒ»
 452   2      
 453   2      #if 0
                              // ½«ÊÕµ½µÄĞÅºÅ¶¼ÏÔÊ¾³öÀ´
                              for (i = 0; i < sizeof(rf_data_buf) / sizeof(rf_data_buf[0]); i++)
                              {
                                      // send_keyval((unsigned short)((rf_data_buf[i] >> 16) & 0xFF));
                                      // send_keyval((unsigned short)(rf_data_buf[i] & 0xFF));
              
                                      send_keyval((unsigned short)(rf_data_buf[i])); // Õâ¸ö¿ÉÒÔÔÚÂß¼­·ÖÎöÒÇÉÏ¿´³ö¶ÔÓ¦µÄ¼üÖµ£¨ºó16Î»Êı¾İ£©
                              }
              #endif
 463   2      
 464   2      #if 0
                              // ÕÒ³ö³öÏÖ´ÎÊı×î¶àµÄÔªËØ
                              appear_themost(rf_data_buf, sizeof(rf_data_buf) / sizeof(rf_data_buf[0]), &appear_themost, &index);
              
                              // send_keyval(appear_themost); // Õâ¸ö¿ÉÒÔÔÚÂß¼­·ÖÎöÒÇÉÏ¿´³ö¶ÔÓ¦µÄ¼üÖµ£¨ºó16Î»Êı¾İ£©
              
                              // if ((((unsigned short)appear_themost) & (~0x0F)) == (u32)0xF0B480) // ²âÊÔÍ¨¹ıµÄ³ÌĞò
                              // {
                              //      if ((appear_themost & 0x0F) == KEY_RF315_A) // == ÓÅÏÈ¼¶Òª´óÓÚ &
                              //      {
                              //              P12 = ~P12;
                              //              send_keyval(KEY_RF315_A);
                              //      }
                              // }
              #endif
 479   2              }
 480   1      }
 481          
 482          // ¼ì²âÊÇ·ñ½ÓÊÕµ½ÁËRFĞÅºÅ£¬²¢¸ù¾İÏàÓ¦µÄÃüÁî½øĞĞ¿ØÖÆ£¨Òò´Ëº¯ÊıÄÚ²»Ö»ÊÇ½ÓÊÕ£¬»¹ÓĞÏàÓ¦µÄ´¦Àí£©
 483          // ²âÊÔÓÃ
C51 COMPILER V9.60.7.0   RF_RECV                                                           07/10/2025 11:57:31 PAGE 9   

 484          void rf_recv(void)
 485          {
 486   1              int i = 0;
 487   1              unsigned char isMatch = 0; // ±êÖ¾Î»£¬Æ÷¼şµØÖ·ÊÇ·ñÓëflashÖĞµÄ·ûºÏ
 488   1      
 489   1              // ÕâÒ»Ïî²âÊÔºó·¢ÏÖ¹¦ÄÜÊÇÕı³£µÄ
 490   1              // send_keyval(addr_info.old_index);
 491   1      
 492   1              // ²âÊÔ ÔÚÑ§Ï°ºóÊÇ²»ÊÇÕæµÄÄÜ´ÓflashÖĞ¶ÁÈ¡24bitµÄµØÖ·
 493   1              // send_keyval((unsigned short)(addr_info.addr[0] >> 16));
 494   1              // send_keyval((unsigned short)(addr_info.addr[0] & 0xFF));
 495   1      
 496   1              // send_keyval((unsigned short)(addr_info.addr[1] >> 16));
 497   1              // send_keyval((unsigned short)(addr_info.addr[1] & 0xFFFF));
 498   1      
 499   1              if (recv_rf_flag)
 500   1              {
 501   2                      // Èç¹û³É¹¦½ÓÊÕÁË24Î»µÄÊı¾İ
 502   2                      recv_rf_flag = 0;
 503   2      
 504   2                      // __DisableIRQ(P0_IRQn); // ½ûÓÃIO¿ÚÖĞ¶Ï£¨Ò»¶¨Òª¹Ø±ÕÖĞ¶Ï£¬·ñÔò»á±»ĞÂµÄRFĞÅºÅ´ò¶Ï£¬µ¼ÖÂºóÃæÔÚÂß¼­·ÖÎöÒÇ¿
             -´µ½µÄ²¨ĞÎÓëÔ¤ÏëµÄ²»Ò»ÖÂ£©
 505   2                      send_keyval(rf_data);
 506   2      
 507   2                      // send_keyval(rf_data >> 16);
 508   2                      // send_keyval(rf_data);
 509   2      
 510   2      #if 0 // ²âÊÔÍ¨¹ıµÄ´úÂë
                        // p11_send_data_8bit_msb(rf_data & 0x0F);
              
                              // ·¢ËÍÇ°ºó¶¼¼Ó¸ö1msµÄĞÅºÅ£¬·½±ã¹Û²ì
                              P11 = 0;
                              delay_ms(1);
                              P11 = 1;
                              delay_ms(1);
                              // p11_send_data_8bit_msb(rf_data); // ²âÊÔÓÃ
                              p11_send_data_16bit_msb(rf_data); // ²âÊÔÓÃ
                              P11 = 1;
                              delay_ms(1);
                              P11 = 0;
                              delay_ms(1);
              
                              rf_data = 0; // ·¢ËÍÍê³Éºó£¬Çå³ı½ÓÊÕµ½µÄÊı¾İ
                                                       // delay_ms(200); // ÕâÀï¼ÓÑÓÊ±Ö÷ÒªÊÇ·ÀÖ¹²»Í£µØ´¥·¢ÖĞ¶Ï£¬µ¼ÖÂºóÃæ½ÓÊÕµ½µÄÊı¾İ²»×¼È·
              #endif
 528   2      
 529   2      #if 0 // ²âÊÔÍ¨¹ıµÄ´úÂë
              
                              // ÏÈÅĞ¶ÏµØÖ·Âë¶Ô²»¶Ô
                              if ((rf_data & (~0x0F)) == (u32)0xF0B480) // ÕâÀïµÄ±È½Ï±ØĞëÒª¼ÓÇ¿ÖÆ×ª»»
                              {
                                      switch (rf_data & 0x0F) // ÅĞ¶Ï½ÓÊÕµ½µÄµÍËÄÎ»£¬µÍËÄÎ»ÊÇ¼üÖµ
                                      {
                                      case KEY_RF315_A: // Èç¹ûÊÇÒ£¿ØÆ÷°´¼üA
                                              send_keyval(KEY_RF315_A);
                                              break;
              
                                      case KEY_RF315_B: // Èç¹ûÊÇÒ£¿ØÆ÷°´¼üB
                                              send_keyval(KEY_RF315_B);
                                              break;
              
                                      case KEY_RF315_C: // Èç¹ûÊÇÒ£¿ØÆ÷°´¼üC
C51 COMPILER V9.60.7.0   RF_RECV                                                           07/10/2025 11:57:31 PAGE 10  

                                              send_keyval(KEY_RF315_C);
                                              break;
              
                                      case KEY_RF315_D: // Èç¹ûÊÇÒ£¿ØÆ÷°´¼üD
                                              send_keyval(KEY_RF315_D);
                                              break;
              
                                      case KEY_RF315_E: // Èç¹ûÊÇÒ£¿ØÆ÷°´¼üE
                                              send_keyval(KEY_RF315_E);
                                              break;
              
                                      case KEY_RF315_F: // Èç¹ûÊÇÒ£¿ØÆ÷°´¼üF
                                              send_keyval(KEY_RF315_F);
                                              break;
                                      }
                              }
              
              #endif
 563   2      
 564   2      #if 0
                              // ÏÈÅĞ¶ÏµØÖ·Âë¶Ô²»¶Ô
                              for (i = 0; i < ADDR_MAX_NUM; i++)
                              {
                                      if (addr_info.addr[i] == (rf_data >> 4))
                                      {
                                              isMatch = 1;
                                              break;
                                      }
                              }
              
                              if (isMatch) 
                              {
                                      // Èç¹ûÊÇµ¥Æ¬»úflashÖĞ±£´æµÄµØÖ·£¬ÔòÏìÓ¦Õâ¸öĞÅºÅ
                                      isMatch = 0;
                                      send_keyval(rf_data >> 16);
                                      send_keyval(rf_data);
                              }
              
              #endif
 584   2                      // __EnableIRQ(P0_IRQn); // Ê¹ÄÜIO¿ÚÖĞ¶Ï
 585   2              }
 586   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    511    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    102      42
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
