C51 COMPILER V9.60.7.0   TK_SET                                                            07/08/2025 17:28:58 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE TK_SET
OBJECT MODULE PLACED IN .\Release\Objects\tk_set.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\lib\tk_set.c LARGE OPTIMIZE(9,SIZE) BROWSE INTVECTOR(0X000C) 
                    -INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\tk_set
                    -.lst) OBJECT(.\Release\Objects\tk_set.obj)

line level    source

   1          /**
   2           ******************************************************************************
   3           * @file    User/tk_lib.c
   4           * @author  HUGE-IC Application Team
   5           * @version V1.0.0
   6           * @date    05-20-2022
   7           * @brief   Main program body
   8           ******************************************************************************
   9           * @attention
  10           * tk_set.cÎÄ¼þÊÇÏµÍ³Ê¹ÓÃµÄÎÄ¼þ£¬²»½¨ÒéÐÞ¸Ä¡£
  11           * ÒÔÏÂº¯ÊýºÍ±äÁ¿ÓÃ»§²»ÐèÒªÐÞ¸Ä
  12           *
  13           *
  14           *
  15           ******************************************************************************
  16           */
  17          
  18          /* Includes ------------------------------------------------------------------*/
  19          #include "include.h"
  20          #include "rf_recv.h" // RF½ÓÊÕÏà¹ØµÄ½Ó¿Ú
  21          #include "my_gpio.h" // Êä³ö¼üÖµµÄÒý½Å
  22          #include "send_key.h"
  23          
  24          #include "rf_learn.h" // "Ñ§Ï°"£¬¼ÇÂ¼µØÖ·
  25          
  26          #include "flash.h" // µ¥Æ¬»úµÄflash²Ù×÷£¬²âÊÔÓÃ
  27          
  28          #include "tmr3.h"
  29          
  30          #include "rf_scan.h"
  31          
  32          #include "stimer0.h"
  33          
  34          /** @addtogroup Template_Project
  35           * @{
  36           */
  37          
  38          /* Private typedef -----------------------------------------------------------*/
  39          /* Private define ------------------------------------------------------------*/
  40          /* Private macro -------------------------------------------------------------*/
  41          /* Private variables ---------------------------------------------------------*/
  42          /* Private function prototypes -----------------------------------------------*/
  43          /* Private functions ---------------------------------------------------------*/
  44          /**
  45           * @}
  46           */
  47          // ÅäÖÃÒ»¸ö10msµÄÖÐ¶Ï
  48          #define PEROID_VAL (SYSCLK / 128 / 100 - 1)
  49          // ÓÃ»§²»ÔÊÐíÐÞ¸Ä
  50          volatile unsigned short xdata __tk_ch_data_0[TK_CH_USE] _at_(0x6000 + 0);
  51          volatile unsigned short xdata __tk_ch_data_1[TK_CH_USE] _at_(0x6000 + TK_CH_USE * 2);
  52          volatile unsigned short xdata __tk_ch_data_2[TK_CH_USE] _at_(0x6000 + TK_CH_USE * 4);
  53          volatile unsigned short xdata __tk_ch_data_3[TK_CH_USE] _at_(0x6000 + TK_CH_USE * 8);
C51 COMPILER V9.60.7.0   TK_SET                                                            07/08/2025 17:28:58 PAGE 2   

  54          volatile unsigned short xdata __tk_ch_data_4[TK_CH_USE] _at_(0x6000 + TK_CH_USE * 10);
  55          volatile unsigned short xdata __tk_ch_data_5[TK_CH_USE];
  56          volatile unsigned short xdata __tk_ch_data_6[TK_CH_USE];
  57          volatile unsigned short xdata __tk_ch_fth[TK_CH_USE];
  58          volatile unsigned short xdata __tk_i_set[TK_CH_USE];
  59          volatile unsigned char xdata __tk_update_cnt[TK_CH_USE];
  60          volatile unsigned char xdata __tk_confirm_cnt[TK_CH_USE];
  61          volatile unsigned char xdata __tk_leave_cnt[TK_CH_USE];
  62          volatile unsigned char xdata __tk_ch_index[TK_CH_USE];
  63          
  64          // ÓÃ»§²»ÔÊÐíÐÞ¸Ä
  65          unsigned long code __tk_adjust_line = TK_DATA_LINE;
  66          unsigned short code __tk_adjust_time = TK_ADJUST_TIME;
  67          unsigned short code __tk_adjust_diff_valu = TK_MAX_DIFF_VALU;
  68          unsigned char code __tk_adjust_en = TK_ADJUST_EN;
  69          
  70          unsigned short code __tk_valid_time = TK_VALID_TIME;
  71          unsigned short code __tk_long_key_time = TK_LONG_KEY_TIME;
  72          unsigned short code __tk_noise_value = TK_NOISE_VAL;
  73          unsigned char code __tk_cs_en = TK_CS_EN;
  74          unsigned char code __tk_tp_en = TK_TP_EN;
  75          unsigned char code __tk_nm_num = TK_MU_CNT;
  76          unsigned char code __tk_base_update_cnt = TK_UPDATE_CNT;
  77          unsigned char code __tk_nm_cm_value = TK_NM_CM_CNT;
  78          unsigned char code __tk_cm_valu = TK_CM_VALE;
  79          unsigned char code __tk_use_num = TK_CH_USE;
  80          
  81          /*
  82          **´¥ÃþÍ¨µÀÐÅÏ¢±í
  83          */
  84          static u16 code TK_CH_EN_BUG[][2] =
  85              {
  86          #if TK0_CH_EN
  87                  {
  88                      0u,           // Í¨µÀÖµ
  89                      TK0_THR_DATA, // ÃÅÏÞÖµ
  90                  },
  91          #endif
  92          
  93          #if TK1_CH_EN
                      {
                          1u,
                          TK1_THR_DATA,
                      },
              #endif
  99          
 100          #if TK2_CH_EN
 101                  {
 102                      2u,
 103                      TK2_THR_DATA,
 104                  },
 105          #endif
 106          
 107          #if TK3_CH_EN
 108                  {
 109                      3u,
 110                      TK3_THR_DATA,
 111                  },
 112          #endif
 113          
 114          #if TK4_CH_EN
                      {
C51 COMPILER V9.60.7.0   TK_SET                                                            07/08/2025 17:28:58 PAGE 3   

                          4u,
                          TK4_THR_DATA,
                      },
              #endif
 120          
 121          #if TK5_CH_EN
                      {
                          5u,
                          TK5_THR_DATA,
                      },
              #endif
 127          
 128          #if TK6_CH_EN
                      {
                          6u,
                          TK6_THR_DATA,
                      },
              #endif
 134          
 135          #if TK7_CH_EN
                      {
                          7u,
                          TK7_THR_DATA,
                      },
              #endif
 141          
 142          #if TK8_CH_EN
                      {
                          8u,
                          TK8_THR_DATA,
                      },
              #endif
 148          
 149          #if TK9_CH_EN
 150                  {
 151                      9u,
 152                      TK9_THR_DATA,
 153                  },
 154          #endif
 155          
 156          #if TK10_CH_EN
 157                  {
 158                      10u,
 159                      TK10_THR_DATA,
 160                  },
 161          #endif
 162          
 163          #if TK11_CH_EN
                      {
                          11u,
                          TK11_THR_DATA,
                      },
              #endif
 169          
 170          #if TK12_CH_EN
                      {
                          12u,
                          TK12_THR_DATA,
                      },
              #endif
 176          
 177          #if TK13_CH_EN
C51 COMPILER V9.60.7.0   TK_SET                                                            07/08/2025 17:28:58 PAGE 4   

                      {
                          13u,
                          TK13_THR_DATA,
                      },
              #endif
 183          
 184          #if TK14_CH_EN
                      {
                          14u,
                          TK14_THR_DATA,
                      },
              #endif
 190          
 191          #if TK15_CH_EN
                      {
                          15u,
                          TK15_THR_DATA,
                      },
              #endif
 197          
 198          #if TK16_CH_EN
                      {
                          16u,
                          TK16_THR_DATA,
                      },
              #endif
 204          
 205          #if TK17_CH_EN
                      {
                          17u,
                          TK17_THR_DATA,
                      },
              #endif
 211          
 212          #if TK18_CH_EN
                      {
                          18u,
                          TK18_THR_DATA,
                      },
              #endif
 218          
 219          #if TK19_CH_EN
                      {
                          19u,
                          TK19_THR_DATA,
                      },
              #endif
 225          
 226          #if TK20_CH_EN
                      {
                          20u,
                          TK20_THR_DATA,
                      },
              #endif
 232          
 233          #if TK21_CH_EN
                      {
                          21u,
                          TK21_THR_DATA,
                      },
              #endif
 239          
C51 COMPILER V9.60.7.0   TK_SET                                                            07/08/2025 17:28:58 PAGE 5   

 240          #if TK22_CH_EN
                      {
                          22u,
                          TK22_THR_DATA,
                      },
              #endif
 246          
 247          #if TK23_CH_EN
                      {
                          23u,
                          TK23_THR_DATA,
                      },
              #endif
 253          
 254          #if TK24_CH_EN
 255                  {
 256                      24u,
 257                      TK24_THR_DATA,
 258                  },
 259          #endif
 260          
 261          #if TK25_CH_EN
                      {
                          25u,
                          TK25_THR_DATA,
                      },
              #endif
 267          };
 268          
 269          /**
 270           * @brief  Touchkey gpio init function
 271           * @param  None
 272           * @retval None
 273           */
 274          void tk_gpio_config(void)
 275          {
 276   1          u8 i = 0;
 277   1      
 278   1          for (i = 0; i < TK_CH_USE; i++)
 279   1          {
 280   2      
 281   2              if (__tk_ch_index[i] < 8)
 282   2              {
 283   3                  if (__tk_ch_index[i] < 4)
 284   3                  {
 285   4                      P0_MD0 &= ~(0x3 << (__tk_ch_index[i] - 0) * 2);
 286   4                      P0_MD0 |= (0x3 << (__tk_ch_index[i] - 0) * 2);
 287   4                  }
 288   3                  else
 289   3                  {
 290   4                      P0_MD1 &= ~(0x3 << (__tk_ch_index[i] - 4) * 2);
 291   4                      P0_MD1 |= (0x3 << (__tk_ch_index[i] - 4) * 2);
 292   4                  }
 293   3              }
 294   2              else if ((__tk_ch_index[i] >= 8) && (__tk_ch_index[i] < 16))
 295   2              {
 296   3                  if (__tk_ch_index[i] < 12)
 297   3                  {
 298   4                      P1_MD0 &= ~(0x3 << (__tk_ch_index[i] - 8) * 2);
 299   4                      P1_MD0 |= (0x3 << (__tk_ch_index[i] - 8) * 2);
 300   4                  }
 301   3                  else
C51 COMPILER V9.60.7.0   TK_SET                                                            07/08/2025 17:28:58 PAGE 6   

 302   3                  {
 303   4                      P1_MD1 &= ~(0x3 << (__tk_ch_index[i] - 12) * 2);
 304   4                      P1_MD1 |= (0x3 << (__tk_ch_index[i] - 12) * 2);
 305   4                  }
 306   3              }
 307   2              else
 308   2              {
 309   3                  if (__tk_ch_index[i] < 20)
 310   3                  {
 311   4                      P2_MD0 &= ~(0x3 << (__tk_ch_index[i] - 16) * 2);
 312   4                      P2_MD0 |= (0x3 << (__tk_ch_index[i] - 16) * 2);
 313   4                  }
 314   3                  else
 315   3                  {
 316   4                      P2_MD1 &= ~(0x3 << (__tk_ch_index[i] - 20) * 2);
 317   4                      P2_MD1 |= (0x3 << (__tk_ch_index[i] - 20) * 2);
 318   4                  }
 319   3              }
 320   2          }
 321   1      }
 322          
 323          /**
 324           * @brief  Touchkey_IRQHandler
 325           * @param  none
 326           * @retval None
 327           */
 328          void TK_IRQHandler(void) interrupt TK_IRQn
 329          {
 330   1          __IRQnIPnPush(TK_IRQn);
 331   1          if (TK_CON2 & (0x1 << 6))
 332   1          {
 333   2              TK_CON2 |= (0x1 << 6);
 334   2              __tk_handler();
 335   2          }
 336   1          __IRQnIPnPop(TK_IRQn);
 337   1      }
 338          
 339          /**
 340           * @brief  Touchkey Module init function
 341           * @param  None
 342           * @retval None
 343           */
 344          void tk_init(void)
 345          {
 346   1          IE_EA = 1;
 347   1          IE3 |= (0x1 << 3);
 348   1          IP6 |= (0x3 << 6);
 349   1          CLK_CON2 |= (0x1 << 6);
 350   1          __EnableIRQ(TK_IRQn);
 351   1          TK_ACON0 = 0x3F;
 352   1          TK_ACON1 = 0x4B;
 353   1          TK_ACON3 = 0x30;
 354   1          TK_PSRCNT = 0x2F;
 355   1          TK_APRECHARGE = 0x4f;
 356   1          TK_APREDISCH = 0x27;
 357   1          TK_ACONVTIME = 0xA8;
 358   1          TK_BASEDIV0 = 0x10;
 359   1          TK_BASEDIV1 = 0x0;
 360   1          TK_BASEDIV2 = 0x0;
 361   1          TK_BASEDIV3 = 0x0;
 362   1          TK_CHCON3 = 0xD0;
 363   1          TK_CON0 = 0x4;
C51 COMPILER V9.60.7.0   TK_SET                                                            07/08/2025 17:28:58 PAGE 7   

 364   1          TK_CON1 = 0x1E;
 365   1          TK_CON2 = 0x02;
 366   1      }
 367          
 368          /**
 369           * @brief  TIMR0_IRQHandler function
 370           * @param  None
 371           * @retval None
 372           */
 373          void WUT_IRQHandler(void) interrupt WUT_IRQn
 374          {
 375   1          // ½øÈëÖÐ¶ÏÉèÖÃIP£¬²»¿ÉÉ¾³ý
 376   1          __IRQnIPnPush(WUT_IRQn);
 377   1          // ÖÜÆÚÖÐ¶Ï
 378   1          if (WUT_CONH & TMR_PRD_PND(0x1))
 379   1          {
 380   2              WUT_CONH |= TMR_PRD_PND(0x1); // Çå³ýpending
 381   2              __tk_ms_handler();            // ±ÕÔ´µÄ£¬²»ÖªµÀ×öÁËÊ²Ã´£¬¿´ÉÏÈ¥ÊÇÈÃCPU½øÈëË¯Ãß£¬µ¥Î»Îªms£¨ÊÖ²áÉÏËµ
             -ÊÇË¯Ãß300ms£©
 382   2          }
 383   1      
 384   1          // ÍË³öÖÐ¶ÏÉèÖÃIP£¬²»¿ÉÉ¾³ý
 385   1          __IRQnIPnPop(WUT_IRQn);
 386   1      }
 387          
 388          #if 0
              /**
               * @brief  TIMER Module init function
               * @param  None
               * @retval None
               */
              void wut_init(void)
              {
                  __EnableIRQ(WUT_IRQn);
                  IE_EA = 1;
              
                  // ÉèÖÃtimer2µÄ¼ÆÊý¹¦ÄÜ£¬ÅäÖÃÒ»¸ö10msµÄÖÐ¶Ï
                  TMR_ALLCON = WUT_CNT_CLR(0x1);
                  WUT_PRH = TMR_PERIOD_VAL_H((PEROID_VAL >> 8) & 0xFF);                       // timer2¼ÆÊýÖÜÆÚ¸ß8Î»
                  WUT_PRL = TMR_PERIOD_VAL_L((PEROID_VAL >> 0) & 0xFF);                       // timer2¼ÆÊýÖÜÆÚµÍ8Î»
                  WUT_CONH = TMR_PRD_PND(0x1) | TMR_PRD_IRQ_EN(0x1);                          // Çå³ýÖÐ¶Ï±êÖ¾Î»²¢Ê¹ÄÜÖÐ¶
             -Ï
                  WUT_CONL = TMR_SOURCE_SEL(0x7) | TMR_PRESCALE_SEL(0x7) | TMR_MODE_SEL(0x1); // ÅäÖÃtimer2Ê±ÖÓÔ´¡¢Ô¤·ÖÆ
             -µÖµ¡¢Ä£Ê½
              }
              #endif // end void wut_init(void)
 407          
 408          /**
 409           * @brief  Touchkey  parameter configuration function
 410           *         °´¼ü²ÎÊýÅäÖÃº¯Êý
 411           *
 412           * @param  None
 413           * @retval None
 414           */
 415          void tk_param_init(void)
 416          {
 417   1          u8 i = 0;
 418   1      
 419   1          /* °´¼üÍ¨µÀ¡¢µçÁ÷¡¢ÁéÃô¶È³õÊ¼»¯ */
 420   1          for (i = 0; i < TK_CH_USE; i++)
 421   1          {
 422   2              __tk_ch_index[i] = (u8)(TK_CH_EN_BUG[i][0] & 0xff); // ´æ·Å°´¼üÍ¨µÀÐÅÏ¢
C51 COMPILER V9.60.7.0   TK_SET                                                            07/08/2025 17:28:58 PAGE 8   

 423   2              __tk_ch_fth[i] = TK_CH_EN_BUG[i][1];                // ´æ·Å°´¼üÍ¨µÀÐÅÏ¢
 424   2              __tk_i_set[i] = TK_CURR_GEAR;                       // ³äµçµçÁ÷
 425   2              __tk_ch_en |= (1UL << __tk_ch_index[i]);            // °´¼üÍ¨µÀÊ¹ÄÜ
 426   2          }
 427   1      
 428   1          /* °´¼üIOÅäÖÃº¯Êý */
 429   1          tk_gpio_config();
 430   1      
 431   1          /* ¿âº¯Êý³õÊ¼»¯ */
 432   1          __tk_lib_init(); // µ÷ÓÃÁË¿â£¨±ÕÔ´£©
 433   1      
 434   1          /* °´¼üÄ£¿éÅäÖÃº¯Êý */
 435   1          tk_init();
 436   1      
 437   1          /* ¶¨Ê±Æ÷ÅäÖÃº¯Êý */
 438   1          // wut_init();
 439   1      }
 440          
 441          /**
 442           * @brief  Touchkey  Circular execution function
 443           * @param  None
 444           * @retval None
 445           */
 446          void tk_handle(void)
 447          {
 448   1          // u32 tmp = 0; // ÁÙÊ±±äÁ¿£¬²âÊÔÓÃ
 449   1      
 450   1          /* ÓÃ»§´úÂë³õÊ¼»¯½Ó¿Ú */
 451   1          user_init();
 452   1      
 453   1          /* µ÷ÊÔ´®¿Ú³õÊ¼»¯ */
 454   1      #if TK_DEBUG_EN
                  debug_gpio_config();
                  debug_uart_config();
              #endif
 458   1      
 459   1          /* °´¼ü³õÊ¼»¯ */
 460   1          tk_param_init();
 461   1      
 462   1          // ÉÏµçºó5ÃëÄÚ½øÐÐÑ§Ï°£¬ÎÞÂÛÓÐÃ»ÓÐÆ÷¼þÓëµ¥Æ¬»úÅä¶Ô£¬¶¼ÍË³ö
 463   1          rf_learn();
 464   1      
 465   1      #if USE_MY_DEBUG
                  printf("sys reset\n"); // ±íÊ¾ÏµÍ³¸ÕÉÏµç / ±»¸´Î»
              #endif                     //   #if USE_MY_DEBUG
 468   1      
 469   1          /* ÏµÍ³Ö÷Ñ­»· */
 470   1          while (1)
 471   1          {
 472   2              /* °´¼üÉ¨Ãèº¯Êý */
 473   2              __tk_scan(); // Ê¹ÓÃÁË¿âÀïÃæµÄ½Ó¿Ú£¨±ÕÔ´¿â£©
 474   2      
 475   2              /* ÓÃ»§Ñ­»·É¨Ãèº¯Êý½Ó¿Ú */
 476   2              user_handle();
 477   2      
 478   2              rf_scan(); // É¨ÃèÊÇ·ñÓÐRFÐÅºÅ£¬ÒÔ¼°×öÏàÓ¦µÄ´¦Àí
 479   2      
 480   2              if (flag_is_reinitialize_touch)
 481   2              {
 482   3                  flag_is_reinitialize_touch = 0;
 483   3                  /* °´¼ü³õÊ¼»¯ */
 484   3                  tk_param_init();
C51 COMPILER V9.60.7.0   TK_SET                                                            07/08/2025 17:28:58 PAGE 9   

 485   3              }
 486   2      
 487   2              // show_addr_info_save_by_type();
 488   2              // show_addr_info_save_by_nums();
 489   2      
 490   2              // delay_ms(500);
 491   2      
 492   2              // ²âÊÔÍ¨¹ý
 493   2              // LED6 = 1;
 494   2              // delay_ms(500);
 495   2              // LED6 = 0;
 496   2              // delay_ms(500);
 497   2      
 498   2              // ²âÊÔÍ¨¹ý
 499   2              // LED7 = 1;
 500   2              // delay_ms(500);
 501   2              // LED7 = 0;
 502   2              // delay_ms(500);
 503   2      
 504   2              // P12 = ~P12;
 505   2      
 506   2              // flash_erase_sector(FLASH_DEVICE_START_ADDR);
 507   2              // rf_learn();
 508   2      
 509   2              // rf_recv();
 510   2      
 511   2              // rf_recv_databuf();
 512   2      
 513   2              /* µ÷ÊÔ´òÓ¡º¯Êý£¬Èç¹û²»ÐèÒª´òÓ¡ÔòÔÚtk_conf.hÖÐ½«TK_DEBUG_ENÉèÖÃÎª0 */
 514   2      #if TK_DEBUG_EN
                      if ((__tk_ms_flag >= 1) && (__tk_adjust_done_peng))
                      {
                          __tk_ms_flag = 0;
                          tk_debug_func();
                      }
              #endif
 521   2      
 522   2              /* Î¹¹· :½¨Òé²»Òª¹Ø±Õ¿´ÃÅ¹·£¬Ä¬ÈÏ2s¸´Î»*/
 523   2              WDT_KEY = WDT_KEY_VAL(0xAA);
 524   2          }
 525   1      }
 526          
 527          /*************************** (C) COPYRIGHT 2022 TAIXIN-IC ***** END OF FILE *****/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    735    ----
   CONSTANT SIZE    =     46    ----
   XDATA SIZE       =     72    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
